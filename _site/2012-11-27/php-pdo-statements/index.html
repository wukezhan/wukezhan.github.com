<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8" />
<title>php pdo statements_指间世界</title>
<link rel="stylesheet" type="text/css" href="/theme/default/css/style.css" />
<link rel="stylesheet" type="text/css" href="/theme/default/css/syntax.css" />
<link rel="alternate" type="application/rss+xml" title="RSS" href="http://feeds.feedburner.com/wukezhan">
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.1/jquery.min.js"></script>
</head>

<body>


<!--[top]-->
<div id="logo">
	<span id="saying">中原王气久消磨，四面军声逼楚歌。仗剑纵横驱虏骑，不教荆棘没铜驼！</span>
	<h1><a href="/">指间世界</a></h1>
</div>
<!--[/top]-->




<div id="wrapper">
    <div id="content">
        <h2 id="post-title">php pdo statements</h2>
        <div id="post-info">
            <span class="post-tags">
                 
                <a class="tag" href="/tag/php/">php</a>
                 
                <a class="tag" href="/tag/mysql/">mysql</a>
                
            </span>
            <span class="post-categories">
                 
                <a class="category" href="/category/code/">code</a>
                
            </span>
            <div class="highlight">
                <pre style="padding:5px 20px;">   <code class="php">$author = "<span class="author"><a href="http://www.wukezhan.com" style="color:green;">湛之</a></span>"; <span class="cm">//@since: 2012-11-27</span></code></pre>
            </div>
        </div>
        <div class="post">
            <h3>概念</h3>

<p>关于预处理语句这个概念，PHP官网有这样一段描述：</p>

<blockquote><p>Prepared statements and stored procedures</p>

<p>Many of the more mature databases support the concept of prepared statements. What are they? They can be thought of as a kind of compiled template for the SQL that an application wants to run, that can be customized using variable parameters. Prepared statements offer two major benefits:</p>

<ul>
<li>The query only needs to be parsed (or prepared) once, but can be executed multiple times with the same or different parameters. When the query is prepared, the database will analyze, compile and optimize its plan for executing the query. For complex queries this process can take up enough time that it will noticeably slow down an application if there is a need to repeat the same query many times with different parameters. By using a prepared statement the application avoids repeating the analyze/compile/optimize cycle. This means that prepared statements use fewer resources and thus run faster.</li>
<li>The parameters to prepared statements don't need to be quoted; the driver automatically handles this. If an application exclusively uses prepared statements, the developer can be sure that no SQL injection will occur (however, if other portions of the query are being built up with unescaped input, SQL injection is still possible).</li>
</ul>


<p>Prepared statements are so useful that they are the only feature that PDO will emulate for drivers that don't support them. This ensures that an application will be able to use the same data access paradigm regardless of the capabilities of the database.</p></blockquote>

<p>可见，prepared statements是SQL的一种编译模板，主要有以下优点：</p>

<ul>
<li>查询只需一次解析（预处理），即可多次执行。在预处理查询时，数据库会自动对其进行分析、编译和优化执行计划。对于复杂的查询而言，在不使用prepared statement的情况下，如果这个查询需要多次以不同的参数分别执行，那么数据库就将相应的多次重复这个预处理过程，这将有可能需要消耗足够多的时间而导致应用程序的运行明显变慢。而使用prepared statement则可有效避免多次重复这个过程，这意味着prepared statements能使查询效率更高、消耗更少。</li>
<li>prepared statements的参数无需做任何处理，pdo将会自动对其进行相应的处理，这些处理包括特殊字符转义、字符串加引号等等。如果对用户的输入都使用prepared statements，将可避免出现数据库遭到SQL注入攻击的情况。</li>
</ul>


<h3>示例</h3>

<div class="highlight"><pre><code class="php"><span class="lineno"> 1</span> <span class="x">    </span><span class="cp">&lt;?php</span>
<span class="lineno"> 2</span>     <span class="c1"># eg. 1</span>
<span class="lineno"> 3</span>     <span class="nv">$stmt</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s2">&quot;INSERT INTO REGISTRY (name, value) VALUES (:name, :value)&quot;</span><span class="p">);</span>
<span class="lineno"> 4</span>     <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindParam</span><span class="p">(</span><span class="s1">&#39;:name&#39;</span><span class="p">,</span> <span class="nv">$name</span><span class="p">);</span>
<span class="lineno"> 5</span>     <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">bindParam</span><span class="p">(</span><span class="s1">&#39;:value&#39;</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
<span class="lineno"> 6</span>     
<span class="lineno"> 7</span>     <span class="c1">// insert one row</span>
<span class="lineno"> 8</span>     <span class="nv">$name</span> <span class="o">=</span> <span class="s1">&#39;one&#39;</span><span class="p">;</span>
<span class="lineno"> 9</span>     <span class="nv">$value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="lineno">10</span>     <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
<span class="lineno">11</span>     
<span class="lineno">12</span>     <span class="c1">// insert another row with different values</span>
<span class="lineno">13</span>     <span class="nv">$name</span> <span class="o">=</span> <span class="s1">&#39;two&#39;</span><span class="p">;</span>
<span class="lineno">14</span>     <span class="nv">$value</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="lineno">15</span>     <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
<span class="lineno">16</span>     <span class="cp">?&gt;</span><span class="x"></span>
<span class="lineno">17</span> <span class="x">    </span>
</code></pre>
</div>


<p>自从用了PDO，代码果然小清新多了。需要注意的是以上示例里的bindParam如果使用不当即为巨坑，详情见<a href="http://www.laruence.com/2012/10/16/2831.html">PDOStatement::bindParam的一个陷阱</a> ，前车之鉴后事之师！</p>

            <p><span class="split-line" style="color:red;">---EOF---</span></p>
<p>
	<span class="license" style="color:green;font-weight:bold;">Code licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0" target="_blank">Apache License v2.0</a>, article under <a href="http://creativecommons.org/licenses/by/3.0/" target="_blank">CC BY 3.0</a>.</span>
</p>
        </div>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
        (function() {
         var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
         dsq.src = 'http://wukezhan.disqus.com/embed.js';
         (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=wukezhan">comments powered by Disqus.</a></noscript>
    </div>
</div>


<!--[footer]-->
<div id="footer">
	<div id="feed">
		<div class="badget" id="github">
			<a href="http://github.com/wukezhan">
			<span class="service">github</span>
			<span class="info"> </span>
			</a>
		</div>
		<div class="badget" id="twt">
			<a href="http://twitter.com/wukezhan">
			<span class="service">twitter</span>
			<span class="info"> </span>
			</a>
		</div>
		<div class="badget" id="feedburner">
			<a href="http://feeds.feedburner.com/wukezhan">
			<span class="service">rss</span>
			<span class="info"> </span>
			</a>
		</div>
	</div>
	<span style="color:#bbb;font-size:12px">copyright © www.wukezhan.com.</span>
	<p style="clear:both"></p>
</div>
<!--[/footer]-->
<script type="text/javascript" src="/theme/default/js/footer.js"></script>

<script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-16656304-1']);
_gaq.push(['_trackPageview']);

(function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>
</body>
</html>